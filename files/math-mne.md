
# Minimum-norm-estimationの理屈
かなり面倒いので丁寧にはかけません。ここからは線形代数の範囲になります。
超簡単に言いますと、一般化逆行列を使って割り算したやつです。
ノイズについてベイズ推定する方法もありますが、
面倒いのでここでは一般化逆行列だけ使って説明します。

まず、脳のソースから出た磁力…電力でも良いですが、
そのようなものがセンサーに届く時、その強さはソースで発生した電力、磁力に比例するはずです。
多分、距離の二乗には反比例すると思います。
つまり…距離云々を除くと簡単な一次連立方程式になるはずなんです。
センサーで捉えた情報を$y$とし、ソースで発生したのを$x$としましょう。
あるソースで発生した電力とセンサーで捉えた電力の関係を下記の式で表せるとします。
$$y=ax$$
これは単純な掛け算なわけですが、1センサー1ソースではなく、多センサー多ソースです。
ここで、沢山になったy,a,xについて、下記のように表すとします。
$$Y={y_1,y_2,y_3......}$$
$$X={x_1,x_2,x_3......}$$
ここで$A$を下記を満たす行列とします。
$$Y=AX$$
この連立方程式を解きます。これがどうしても連立方程式に見えない人は、
行列代数の入門書でも読んで下さい。ネットで検索するよりこれは本の方がいいです。

では解きま…じつは解けません。
一時連立方程式はあんまり数が多くなると解けなくなるのです。
ですが、最も真実に近いっぽいのを推定することは出来ます。
今回、脳全体のある一瞬の波が最も小さくなるような波を推定しましょう。
Minimum-norm-estimation(MNE)と言います。
(他に一つ一つの波が一番小さくなるbeamformer法とか色々あります)
導出は有名なムーアペンローズの逆行列とよく似ていますので、
それを勉強すれば理解が早まると思います。

つまり、条件$Y=AX$のもとで$X$を小さくしたい[^norm]のです。
$X$が小さいってことは下記の式が小さいってことです。
$$||X||^2$$

[^norm]: ノルムが小さいということ。中学生風に言うと絶対値。

まず、ラグランジュの未定乗数法という公式を使います。[^MP]

[^MP]: ムーアペンローズの逆行列ではよくあること。

$f(x,y)$が極値になるx,yは

$$L(x,y,\lambda)=f(x,y)-\lambda g(x,y)$$
の時に

$$\frac{\partial L}{\partial \lambda}= \frac{\partial L}{\partial y}= \frac{\partial L}{\partial x}=0$$
の解、または
$$\frac{\partial g}{\partial x}= \frac{\partial g}{\partial y}$$
の解。…という感じの公式です。
行列の微分をしないといけないので、行列の微分の仕方を確認しておきます。
$$\frac{\partial a^tx}{\partial x}=a$$
$$\frac{\partial x^ta}{\partial x}=a$$

今回はこれを微分します。
$$L=||X||^{2}-\lambda ||Y-AX||^{2}$$

$$L = X^{T}X - \lambda (Y - AX)^{T}(Y - AX)$$
$$= X^{T}X - \lambda (Y^{T} - X^{T}A^{T})(Y - AX)$$
$$= X^{T}X - \lambda (Y^{T}Y - X^{T}A^{T}Y - Y^{T}AX + X^{T}A^{T}AX)$$
$$\frac{\partial L}{\partial X} = 2X - \lambda(- A^{T}Y - A^{T}Y + (A^{T}A + A^{T}A)X)$$
$$= 2\lambda(A^{T}Y - A^{T}AX + \frac{X}{\lambda})$$
これが0になるので
$$(A^{T}A - \frac{I}{\lambda})X = A^{T}Y$$
$$X = (A^{T}A - \frac{I}{\lambda})^{-1}A^{T}Y$$
ここで$\frac{I}{\lambda}$をCとおくと
$$X = (A^{T}A - CI)^{-1}A^{T}Y$$

これで無事$X$を$A$と$Y$で表せました。
Cというのが出てきましたが、これはまぁ…定数です。

ものすごくざっくりというとこの様な事です。
では、次に重み付けをしてみましょう。

## MNEの重み付け
さて、MNEは重み付けを行うことが出来ます。
これはMEGの場合は特に大事です。何故なら、MEGは計測の
方法[^grad]によっては脳の表面の皮質の信号しか捉えられないからです。
どの値を重視して推定していくかが設定できるわけです。
また、上記の式は不十分な部分があります。
ノルムの種類がこれでは一寸困るところがあるのです。
実際はL2ノルムというのを使います。
では、重みを付けてみましょう。

[^grad]: グラディオメーターのばあい。
さっきは

$$||X||^2$$
を最小にするようなものでしたが、 これは重みが入っていません。
重みの行列を仮に$w$として、その上で
$$X^{T}wX$$
が最小になるような条件を設定してあげればいいです。
この$w$は縦と横の長さが同じ正方行列かつ、対角線上以外全部0の行列です。
こういうのを掛け算すると重み付けが出来るんですね。
そりゃそうです。行列Iの要素に順番にスカラー値を掛け算していくわけなので、
重みになります。

ではそのことを踏まえて今回はこれを微分します。
$$L = X^{T}wX - \lambda ||Y-AX||^{2}$$

$$L = X^{T}wX - \lambda (Y - AX)^{T}(Y - AX)$$
$$= X^{T}wX - \lambda (Y^{T} - X^{T}A^{T})(Y - AX)$$
$$= X^{T}wX - \lambda (Y^{T}Y - X^{T}A^{T}Y - Y^{T}AX + X^{T}A^{T}AX)$$
$$\frac{\partial L}{\partial X} = (w + w^{T})X - \lambda(- A^{T}Y - A^{T}Y + (A^{T}A + A^{T}A)X)$$
$$= 2\lambda(A^{T}Y - A^{T}AX + \frac{(w + w^{T})X}{2\lambda})$$
$$= 2\lambda(A^{T}Y - A^{T}AX + \frac{wX}{\lambda})$$
$$= 2\lambda(A^{T}Y - (A^{T}A + \frac{w}{\lambda})X)$$

これが0になるので
$$(A^{T}A + \frac{w}{\lambda})X = A^{T}Y$$
$$(\lambda A^{T}A + w)X = \lambda A^{T}Y$$
$$X = \lambda (\lambda A^{T}A + w)^{-1}A^{T}Y$$

凄いですね！これやこの、重み付きMNEの式です。


## MAP推定
今回はラグランジュの未定乗数法で二乗したのがxだけでしたが、
ここに正規化する変数を入れてやる必要があります。
その操作をしたのが下記です。

また、YとXについてはベイズ統計学のMAP推定した結果と同じになるのですが、
これはここに書くのが超絶面倒いので書きません。

これの解説だけで本が一冊書けます。

## dSPMの理屈
さて…MNEの式をよく眺めてみましょう。
これは
$$Y=AX$$
の変形であり、シンプルな掛け算なのは言うまでもありません。
そこで、MNEの式を次のように書き直してみます。
$$X=BY$$

ここで、ふとした疑問が出てきます。
Bの絶対値が1じゃない場合です。
Bが1じゃない場合で、空室を撮ったと仮定してみて下さい。
センサーが捉えるノイズと空室のノイズは同じ大きさのはずですが、
Bが1だったら空室がうまく説明できませんね？？？
ということで、これを補正してみます。

$$X'=\frac{BY}{||B||}$$
$$X'=\frac{BY}{\sqrt{BCB^{T}}}$$

このように、ノルムが1になるように割り算してあげることを数学の言葉で
正規化といいます。MNEの結果を正規化したものがdSPMです。
これが僕のdSPMに対する理解です。

ところで、分散を1にしてあげる方法もあるのですが、
これを標準化と言います。
かの有名なsLORETAはdSPMに対して正規化ではなく標準化したものです。
式はこうです。
$$X'=\frac{BY}{\sqrt{B}}$$

間違ってたらごめん(´・ω・｀)
