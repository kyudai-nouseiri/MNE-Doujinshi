
# Minimum-norm-estimationの理屈
かなり面倒いので丁寧にはかけません。ここからは線形代数の範囲になります。
超簡単に言いますと、一般化逆行列を使って割り算したやつです。
ノイズについてベイズ推定する方法もありますが、
面倒いのでここでは一般化逆行列だけ使って説明します。

まず、脳のソースから出た磁力…電力でも良いですが、
そのようなものがセンサーに届く時、その強さはソースで発生した電力、磁力に比例するはずです。
多分、距離の二乗には反比例すると思います。
つまり…距離云々を除くと簡単な一次連立方程式になるはずなんです。
センサーで捉えた情報を$y$とし、ソースで発生したのを$x$としましょう。
あるソースで発生した電力とセンサーで捉えた電力の関係を下記の式で表せるとします。
$$y=ax$$
これは単純な掛け算なわけですが、1センサー1ソースではなく、多センサー多ソースです。
ここで、沢山になったy,a,xについて、下記のように表すとします。
$$Y={y_1,y_2,y_3......}$$
$$X={x_1,x_2,x_3......}$$
ここで$A$を下記を満たす行列とします。
$$Y=AX$$
この連立方程式を解きます。これがどうしても連立方程式に見えない人は、
行列代数の入門書でも読んで下さい。ネットで検索するよりこれは本の方がいいです。

では解きま…じつは解けません。
一時連立方程式はあんまり数が多くなると解けなくなるのです。
ですが、最も真実に近いっぽいのを推定することは出来ます。
今回、脳全体のある一瞬の波が最も小さくなるような波を推定しましょう。
この方法はムーアペンローズの逆行列と言われるものであり、
そのやり方を脳に応用したものをMinimum-norm-estimation(MNE)と言います。
(他に一つ一つの波が一番小さくなるbeamformer法とか色々あります)

つまり、条件$Y=AX$のもとで$X$を小さくしたい[^norm]のです。
$X$が小さいってことは下記の式が小さいってことです。
$$||X||^2$$

[^norm]: ノルムが小さいということ。中学生風に言うと絶対値。

まず、ラグランジュの未定乗数法という公式を使います。[^MP]

[^MP]: ムーアペンローズの逆行列ではよくあること。

$f(x,y)$が極値になるx,yは

$$L(x,y,\lambda)=f(x,y)-\lambda g(x,y)$$
の時に

$$\frac{\partial L}{\partial \lambda}=
\frac{\partial L}{\partial y}=
\frac{\partial L}{\partial x}=0$$
の解、または
$$\frac{\partial g}{\partial x}=
\frac{\partial g}{\partial y}$$
の解。…という感じの公式です。
行列の微分をしないといけないので、行列の微分の仕方を確認しておきます。
$$\frac{\partial a^tx}{\partial x}=a$$
$$\frac{\partial x^ta}{\partial x}=a$$
これにより、
$$L=||X||^{2}-\lambda (Y-AX)$$
という式を$x$と$\lambda$でそれぞれ微分して下記のようになります。
$$2X-A^T\lambda=0$$
$$Y-AX=0$$
では変形していきましょう。
$$Y=AX$$
$$2X=A^T\lambda$$
$$Y=A\frac{A^T\lambda}{2}$$
$$(AA^T)^{-1}Y=\frac{\lambda}{2}$$
$$A^T(AA^T)^{-1}Y=A^T\frac{\lambda}{2}$$
$$A^T(AA^T)^{-1}Y=X$$
これで無事$X$を$A$と$Y$で表せました。

では、次に重み付けをしてみましょう。

## MNEの重み付け
さて、MNEは重み付けを行うことが出来ます。
これはMEGの場合は特に大事です。何故なら、MEGは計測の
方法[^grad]によっては脳の表面の皮質の信号しか捉えられないからです。
どの値を重視して推定していくかが設定できるわけです。
では、重みを付けてみましょう。
[^grad]: グラディオメーターのばあい。
さっきは

$$||X||^2$$
を最小にするようなものでしたが、 これは重みが入っていません。
重みの行列を仮に$w$として、その上で
$$X^{T}wX$$
が最小になるような条件を設定してあげればいいです。
この$w$は縦と横の長さが同じ正方行列です。
なので、こいつはほぼほぼ逆行列を作ることが出来るはずです。
さらに、下記も正方行列になるので逆行列が作れます。
$$Aw^{-1}A^{T}$$
ではそのことを踏まえて変形していきます。

$$Y=AX$$
$$2wX=A^T\lambda$$
$$2X=w^{-1}A^T\lambda$$
$$Y=A\frac{w^{-1}A^T\lambda}{2}$$
$$(Aw^{-1}A^T)^{-1}Y=\frac{\lambda}{2}$$
$$A^T(Ax^{-1}A^T)^{-1}Y=A^T\frac{\lambda}{2}$$
$$A^T(Aw^{-1}A^T)^{-1}Y=wX$$
$$w^{-1}A^T(Aw^{-1}A^T)^{-1}Y=X$$

凄いですね！これやこの、MNEの式です。

## ベイズ推定
今回はラグランジュの未定乗数法で二乗したのがxだけでしたが、
ここに正規化する変数を入れてやる必要があります。
その操作をしたのが下記です。

また、YとXについてはベイズ統計学のMAP推定した結果と同じになるのですが、
これはここに書くのが超絶面倒いので書きません。
$$w^{-1}A^T(Aw^{-1}A^T+C)^{-1}Y=X$$

これの解説だけで本が一冊書けます。

## dSPMの理屈
さて…MNEの式をよく眺めてみましょう。
これは
$$Y=AX$$
の変形であり、シンプルな掛け算なのは言うまでもありません。
そこで、MNEの式を次のように書き直してみます。
$$X=BY$$

ここで、ふとした疑問が出てきます。
Bの絶対値が1じゃない場合です。
Bが1じゃない場合で、空室を撮ったと仮定してみて下さい。
センサーが捉えるノイズと空室のノイズは同じ大きさのはずですが、
Bが1だったら空室がうまく説明できませんね？？？
ということで、これを補正してみます。

$$X'=\frac{BY}{||B||}$$
$$X'=\frac{BY}{\sqrt{BCB^{T}}}$$

これで正規化したものができるはずです。 これが僕のdSPMに対する理解です。

間違ってたらごめん(´・ω・｀)
