# Minimum-norm-estimationの理屈
かなり面倒いのと自身がないのとで丁寧にはかけません。
ここからは線形代数の範囲になります。
超簡単に言いますと、一般化逆行列を使って割り算した上で、
ノイズについてベイズ推定するというものです。

まず、脳のソースから出た磁力…電力でも良いですが、
そのようなものがセンサーに届く時、その強さはソースで発生した電力、磁力に比例するはずです。
多分、距離の二乗には反比例すると思います。
つまり…距離云々を除くと簡単な一次連立方程式になるはずなんです。
センサーで捉えた情報を$y$とし、ソースで発生したのを$x$としましょう。
あるソースで発生した電力とセンサーで捉えた電力の関係を下記の式で表せるとします。
$$y=ax$$
これは単純な掛け算なわけですが、1センサー1ソースではなく、多センサー多ソースです。
ここで、沢山になったy,a,xについて、下記のように表すとします。
$$Y={y_1,y_2,y_3......}$$
$$X={x_1,x_2,x_3......}$$
ここで$A$を下記を満たす行列とします。
$$Y=AX$$
この連立方程式を解きます。これがどうしても連立方程式に見えない人は、
行列代数の入門書でも読んで下さい。ネットで検索するよりこれは本の方がいいです。

では解きま…じつは解けません。
一時連立方程式はあんまり数が多くなると解けなくなるのです。
ですが、最も真実に近いっぽいのを推定することは出来ます。
今回、脳全体のある一瞬の波が最も小さくなるような波を推定しましょう。
そのやり方をMinimum-norm-estimationと言います。
(他に一つ一つの波が一番小さくなるbeamformer法とか色々あります)

つまり、条件$Y=AX$のもとで$X$を小さくしたいのです。
(ノルムが小さい。中学生風に言うと絶対値)
$X$が小さいってことは下記の式が小さいってことです。
$$||X||^2$$

まず、ラグランジュの未定乗数法という公式を使います。
普通の最小二乗法ではいけません。理由は少ない方程式から沢山の解を
得ようとすると、最小二乗法では解が定まらないからです。
$f(x,y)$が極値になるx,yは

$$L(x,y,\lambda)=f(x,y)-\lambda g(x,y)$$
の時に

$$\frac{\partial L}{\partial \lambda}=
\frac{\partial L}{\partial y}=
\frac{\partial L}{\partial x}=0$$
の解、または
$$\frac{\partial g}{\partial x}=
\frac{\partial g}{\partial y}$$
の解。…という感じの公式です。
行列の微分をしないといけないので、行列の微分の仕方を確認しておきます。
$$\frac{\partial a^tx}{\partial x}=a$$
$$\frac{\partial x^ta}{\partial x}=a$$
これにより、
$$L=||X||^{2}-\lambda (Y-AX)$$
という式を$x$と$\lambda$でそれぞれ微分して下記のようになります。
$$2X-A^T\lambda=0$$
$$Y-AX=0$$
では変形していきましょう。
$$Y=AX$$
$$2X=A^T\lambda$$
$$Y=A\frac{A^T\lambda}{2}$$
$$(AA^T)^{-1}Y=\frac{\lambda}{2}$$
$$A^T(AA^T)^{-1}Y=A^T\frac{\lambda}{2}$$
$$A^T(AA^T)^{-1}Y=X$$
これで無事$X$を$A$と$Y$で表せました。

では、次に重み付けをしてみましょう。

# MNEの重み付け
さて、MNEは重み付けを行うことが出来ます。
これはMEGの場合は特に大事です。何故なら、MEGは計測の
方法によっては脳の表面の皮質の信号しか捉えられないからです。
どの値を重視して推定していくかが設定できるわけです。
では、重みを付けてみましょう。
さっきは

$$||X||^2$$
を最小にするようなものでしたが、 これは重みが入っていません。
重みの行列を仮に$w$として、その上で
$$X^{T}wX$$
が最小になるような条件を設定してあげればいいです。
この$w$は縦と横の長さが同じ正方行列です。
なので、こいつはほぼほぼ逆行列を作ることが出来るはずです。
さらに、下記も正方行列になるので逆行列が作れます。
$$Aw^{-1}A^{T}$$
ではそのことを踏まえて変形していきます。

$$Y=AX$$
$$2wX=A^T\lambda$$
$$2X=w^{-1}A^T\lambda$$
$$Y=A\frac{w^{-1}A^T\lambda}{2}$$
$$(Aw^{-1}A^T)^{-1}Y=\frac{\lambda}{2}$$
$$A^T(Ax^{-1}A^T)^{-1}Y=A^T\frac{\lambda}{2}$$
$$A^T(Aw^{-1}A^T)^{-1}Y=wX$$
$$w^{-1}A^T(Aw^{-1}A^T)^{-1}Y=X$$

凄いですね！これやこの、L1ノルムのMNEの式です。
でも、実はこれだけじゃ不十分です…。

# L2ノルムMNEとベイズ推定
今回はラグランジュの未定乗数法で二乗したのがxだけでしたが、
実際は$Y-AX$も二乗して計算します。(L2ノルムといいます)
そうしないと(説明は難しいですが)良い計算結果が出ないのです。
また、YとXについてノイズを考慮してMAP推定するのですが、
これはここに書くのが超絶面倒いので書きません。
具体的にはYとXのノイズの比をCとすると下記です。
$$w^{-1}A^T(Aw^{-1}A^T+C)^{-1}Y=X$$

この辺りを全て理解するためにはムーアペンローズの逆行列と
MAP推定を勉強すると良いと思いますが、それはまた別のお話。


# dSPMの理屈
さて…MNEの式をよく眺めてみましょう。
これは
$$Y=AX$$
の変形であり、シンプルな掛け算なのは言うまでもありません。
そこで、MNEの式を次のように書き直してみます。
$$X=BY$$

どうしてもノイズはのってしまうわけですが、
そこで、なんとかする方法としてノイズの大きさを測っておいて、
そのノイズと本来の反応を比べる様な割り算をしてやる方法があります。
それをdSPMといいます。
MNEが点数とすると、dSPMは偏差値のようなものですね。
ここでノイズの分散をC、標準偏差をHとおきます。
このノイズというのは環境そのものなので、空室でMEG取ることでつくれます。
$$X=BY$$
$$X'=\frac{BY}{||BH||}$$
$$X'=\frac{BY}{\sqrt{BCB^{T}}}$$

これで正規化したもの(偏差値的な物)ができるはずです。
結論として

$$w^{-1}A^T(Aw^{-1}A^T+c)^{-1}=B$$
とする時
$$X'=\frac{BY}{\sqrt{BCB^{T}}}$$
とするのが僕のdSPMに対する理解です。
間違ってたらごめん(´・ω・｀)
