
# 初心者のための波形解析
ここまで実践を行ってきましたが、ブラックボックスでした。
でも、理解する努力はすべきでしょう。
ここから理論編に入ります。

内容は高校数学(地獄級)でギリギリやれますし工学部生は大抵理解しています(?)が、
初心者には結構難しいです。また、本書はあんま頭のいい人が書いてるわけじゃないです。
だから、ここでは物凄くざっくり(やや不正確な)解説をします。
…というか、算数が苦手なので不正確な話しかできません。

## 波形解析で得たいものと、必要な変換
脳波や脳磁図を解析して貴方は何を得たいでしょうか？
脳波や脳磁図の特定の波長…例えばα波、β波、γ波等の強さを求めたいですね！それもミリ秒単位で！
また、どのくらい位相が揃っているかとかも見たいです。
波と波の関係性とかもみたいですね。
なので、必要なのは下記を兼ね備えたデータです。

- 波の強さ
- 波の位相
- 波の位置(ミリ秒単位)
- 注目した周波数以外は無視できる
- 波と波の関係性

波というものは位相があります。出っ張りもあれば凹みもあって、しかもいろいろな波が
重なっていたりして定量化しにくいです。特定の周波数の波の出っ張りと凹みを
両方同じように評価するにはどうすればいいでしょう？

これらを実現するのが時間周波数解析です。
本当は色々な種類の時間周波数解析があるのですが、
ここでは以下の3つの解析を解説しようと思います。

- フーリエ変換
- 連続morlet wavelet変換
- ヒルベルト変換

## フーリエ変換とは
調べたい波を、全てsinとcosだけで表してしまうやりかたです。
周波数ごとに長いsin,cos波を大きくしたり小さくしたりしながら当てはめます。
要するに、周波数ごとに
$Acosx + Bsinx$
という形に直していきますが、実はもう一寸スマートなやり方があって
$Acosx + Bisinx$
という複素数の形式(!?)に落とし込んでいくのを目指します。
理由は波の強さ、位相を観察するためには複素数のほうが都合がいいからです。

## 連続morlet wavelet変換とは
しかし、sinもcosも未来永劫絶対に減衰しない波であるため、
不規則な波のフーリエ変換はきついです。実は完全にダメではなく、
「一部を無理やり切り取ってきて、切り取った波が永遠に続く波と
想定した上で変換すること」は一応可能です。[^hukakutei]
そこで、フーリエ変換にほんの少しの細工を施して時間軸を加味したのが
連続morlet wavelet変換です。(以下、wavelet変換)

[^hukakutei]:この、永遠に続く波じゃないと無理っぽい感じになることをフーリエ変換の不確定性と言います。連続する波をぶつ切りにすると、端っこが不揃いになったりして、そこの処理もしないといけないです。

理解するためにはフーリエ級数を理解する必要があります。

## ヒルベルト変換
上記とはちょっと違った風な時間周波数解析ですが、
その性質や使い方はwavelet変換によくにています。
wavelet変換は一つの波から「実数部分と虚数部分を抽出してくる変換」
と言えますが、ヒルベルト変換は
「元の波から架空の虚数軸部分を作っちゃう変換」みたいなイメージです。
こちらはbandpass-filterに応用されたりします。

## フーリエ級数

早速ですが、フーリエ変換の時、元の波は下記のように表します。

$$f(x)=a_0+\sum_{k=1}^{\infty}(a_n\cos{\frac{2\pi nt}{T}}+b_n\sin{{\frac{2\pi nt}{T}}})$$

これは何かというと、波を変換している式です。解説します。それぞれ…

- $f(x)$:元の波を表す式
- $a_0$:波のベースの高さ
- t:時間
- n:解析したい周波数に対応した変数
- T:周期(任意の定数)
- 右辺:特定周波数の波を表す式

かなり複雑な式っぽいですが、$\sum$の中を御覧ください。
解析したい周波数が変数として与えられてます。これは、特定の周波数だけにしか対応しないのです。

大抵の波はこの単純な波の足し算で説明することが出来るのです。

実はこの方程式を積分したりして解けば、各nに対するaもbも算出することが出来ます。
右辺全体をフーリエ級数、aとbをフーリエ係数と言います。
この式によって規則的なほとんど全ての波を別形式に書き換えられます。
凄いですね！ですが、それだけでは面白くありません。
波をこのように別の式に書き換えた所で僕達がほしい
「波の強さ」「波の位相同期性」「波の位置」の情報がないからです。
なので、上の式を数学的に変換して公式を求めます。

## 複素フーリエ級数
高校数学の複素数平面を覚えているでしょうか？全ての二次元の座標は
複素数平面上で下記の式によって表現できます。
$$r(cos\theta+isin\theta)$$
この式です。最終的にはこの様な形に成れば、波の強さも位相も分かるはずです。

さて、貴方はオイラーの公式をご存知でしょうか？
この世で最も美しく偉大な公式の一つです。高校数学(地獄級)でギリギリ出てきます。下記です。

$$e^{i\theta}=cos\theta+isin\theta$$

何度見ても美しい公式ですね。[^toushiki]証明はググってください。
これは美しいだけでなく役に立ちます。まずはこのオイラーの公式による変換を考えます。

端折りますが、オイラーの公式を変形するとsinとcosをeとiで表現することが可能ですので、
フーリエ級数の式からsinとcosを排除できます。高校数学(地獄級)で弄くり倒すと、
$$f(x)=\sum_{n=-\infty}^{\infty}C_ne^{i\pi t/T}$$
と変形できます。Cnは変換a,bを複素数でまとめたものです。
この式の右辺を複素フーリエ級数といいます。
フーリエ変換とはフーリエ係数を求める計算のことです。

$f(x)$は元の波、$e^{i\pi t/T}$はオイラーの公式を見ると…極座標で言うと半径1の円ですね。

ここで知りたいのはCnです。
Cnを求めるにはやはり高校数学(地獄級)によって下記のように書き換えられます。
$$C_n=\frac{1}{T}\int_{-T/2}^{T/2}x(t)e^{-2\pi nt/T}$$
$f(x)$は脳波や脳磁図の結果ですので、フーリエ変換は
脳波や脳磁図に絶対値1の複素数を掛け算して積分する操作といえそうです。

i乗とか実際に計算するのはアレなので、実際の計算をする時も
オイラーの公式で展開…と言いたいところなのですが、
python3なんかは複素数の演算ができるので、$e^i$を計算できたりします。凄いですね！！！

というわけで、上の式をそのままpython3流に書けばフーリエ変換は
自分でコーディングすることが出来るわけです。でも、僕は自分ではしないです。
既にそれをするスクリプトが開発されているからです。[^saihatu]

ところで、フーリエ変換にはFFTという超速いアルゴリズムがあります。
これは畳み込みの定理を組み合わせることでwavelet変換にも応用できます。
結果は変わらないのでMNEとかでは使うといいでしょう。

![再掲。morlet waveletの2Dプロット](img/wavelet_base.png)

![再掲。3Dプロット](img/3d_wavelet_base.png)

[^saihatu]:既に作られているものをもう一回作る無駄のことを、業界では「車輪の再発明」と言います。

## 結局何をしているのか
要するに基準となる複素数の波(エネルギー1)を物差しにして、

$波=特定の周波数の波1+特定の周波数の波2+特定の周波数の波3...$

$特定の周波数の波=定数 * 基準の波$

という感じに変えていく計算です。
沢山ある定数(数列ですね)さえわかれば波が表せます。
で、この定数を複素数にしたものが複素数版フーリエ級数。
複素数だから「定数」の絶対値や位相が計算しやすい、ということです。

さて、今あなたは周波数ごとに
$A + Bi$ または $(r,\theta)$ という形の複素数を得ることが出来ています。
これをどう料理していくかが次の問題です。
ここまでくれば高校の複素数です。

## スペクトル解析
得たかったものは何だったか思い出しましょう。
複素数から「絶対値、位相」が分かるというのは
高校時代に数学をしたことのある人は明らかでしょう。
では、脳波の強さとは何でしょうか？それはエネルギーです。
即ち、絶対値の二乗に他なりません！
脳波の位相はもちろん、上記の複素数の位相成分ですね。

フーリエ変換で出て来る数値(フーリエなら係数に相当するやつ)の絶対値は
スペクトルと呼ばれるものです。
特に、自分自身に自分自身を掛け算したものの積分は「パワースペクトル」といいます。
$f(\omega)$の絶対値の二乗が力(パワー)、そして位相がそのまま位相です。

この、パワースペクトルの時間単位の平均値が
パワースペクトル密度(PSD)と言われ、モダンな脳波解析の結果の一つです。

では、位相についてはどうするでしょうか？
これについては「毎回同じ位相を取り続けるかどうか」であったり、
「他の場所の位相とどのくらい差があるか」であったりします。

毎回同じかどうかはPhaseLockingFactorとかInterTrialCoherenceと呼ばれ、
それぞれPLF、ITCと略されます。
他の場所の位相とどのくらい差があるかはPhaseLockingValueと呼ばれ、
PLVと略されます。

さて、位相の差を求めるにはどうすればいいでしょうか？
それは大したことはありません。
複素数 $A + iB$ について考えてみましょう。
これの絶対値は $ (A + iB)(A - iB) $であることは自明です。
すなわち、複素共役同士を掛け算したものです。
これ、自分自身をかけ合わせると位相が0になりますが、
他の波の複素共役と掛け合わせると位相の引き算になるのです。
コネクティビティはこういうのを使っていきます。

さて、これまで「複素共役を掛け算して積分したもの」がいっぱい出てきました。
長いので、よく下記のように略されます。
Sxx (xとx、つまり自分と自分の関係、パワースペクトル)
Sxy (xとy、つまり自分と他人の関係、クロススペクトル)
以下、このように書いていきます。

## そしてwavelet変換へ

一旦話を戻し、まずはPowerを考えます。
フーリエ変換の時点では周波数ごとの複素数が一つづつありました。
これでは時間の次元が失われていますね。いつそのPowerだったんだよと思います。
この理由は、フーリエ変換に使うsinとcosが永遠に続く波であるからです。
永遠に続く波を使えば、そりゃ時間軸は表現できるわけ無いです。

それを解決するのがwavelet変換です。
時間軸を表現するためにものさしに使うものは減衰する波の必要があります。
減衰させるには色々あるのですが、morlet waveletでは以下のようにします。

$$e^{-iwx}e^{-x^2}$$
この、左側がフーリエ変換のためのやつ、右に付け加えたのが減衰するやつ。

こんな感じの式に色々と定数を付けたのがmorlet waveletです。
何故定数をつけるかというと、掛け算するときに掛け合わせるものの
絶対値が1じゃないとエネルギーを計算するのが超面倒だからです。
くるくる回りながら減衰する波です。

3Dプロットのとおりですね。ちなみに、これは他にも色々あるやり方の一つです。

morlet waveletも計算結果が複素数平面として出てきますから、
さっきと同じようにPowerと位相が分かるはずです。
しかも、時間別に！

初めてフーリエ級数とか聞いた人はここまで読んで意味がわからなかったと思います。
そんな人には高校数学の美しい物語の複素フーリエ級数関連の記事をお勧めします。

[^toushiki]:ちなみに、$\theta$が1の場合はオイラーの等式と言います。

## wavelet逆変換とbandpass filter

上記のようにwavelet変換は数値を出すのに応用できるのですが、
これは実はbandpass filterにも応用することが出来ます。
何故なら、周波数を分けちゃう事ができるのと、wavelet変換は逆変換が出来るからです。
wavelet逆変換が出来るのは、上記を見れば自明かと思います。
手順としては、wavelet変換したものの中から欲しい周波数帯域を選んで、
wavelet逆変換を行えばbandpass filterになります。

## もう一つの時間周波数解析、ヒルベルト変換

wavelet変換は1つの実数の波から実軸と虚軸を分離しました。
でも、そもそも元々の波は実軸に存在します。おかしいですね？

元々の実軸をそのまま実軸にして、新たな虚軸を生み出す変換が
ヒルベルト変換です。これはbandpass filterに応用されたりしていますし、
パワーの算出にも使われます。
wavelet変換は掛け算をして積分をして算出していましたが
ヒルベルト変換では双曲線を掛け算します。
一部無限大が出てきて気持ち悪さが残りますが、仕様です。
![双曲線](./img/soukyoku.png)
これについては、既にwavelet変換と同等の性能を持っていることが
分かっている…らしいですが、実際どうなんでしょうね？

